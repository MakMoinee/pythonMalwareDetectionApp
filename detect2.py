import pandas as pd
import joblib
from scapy.all import sniff, Ether, IP, TCP
import sys

# Load the trained model
classifier = joblib.load('malware_detection_model.joblib')

# Define a function to process each captured packet
def process_packet(packet):
    if Ether in packet and IP in packet and TCP in packet:
        # Extract relevant features from the packet (adjust this based on your dataset)
        packet_features = {
            'millisecond': packet.time,
            # Extract other packet features here...
        }

        # # Create a DataFrame from the extracted features
        # incoming_packet = pd.DataFrame(packet_features, index=[0])

        # # Extract features for prediction
        # incoming_packet_features = incoming_packet.drop('hash', axis=1)  # Adjust according to your data
        # incoming_packet_features = incoming_packet_features.values.reshape(1, -1)

        # # Use the loaded classifier to predict whether the packet is malware or not
        # prediction = classifier.predict(incoming_packet_features)

        # # Display the prediction
        # if prediction[0] == 'malware':
        #     print("The incoming packet is predicted as malware.")
        # else:
        #     print("The incoming packet is predicted as non-malware.")

        # Log packet details to a file
        current_id = sys.argv[1] if len(sys.argv) > 1 else 'default_id'
        with open(f"./logs/{current_id}.txt", "a") as log_file:
            # log_file.write(f"Packet Details:\n{packet.summary()}\nPrediction: {prediction[0]}\n\n")
            log_file.write(f"Packet Details: {packet.summary()}\n")

# Start capturing packets using scapy's sniff function
# Adjust the filter and count parameters as needed
sniff(filter="tcp and (port 80 or port 443)", prn=process_packet, count=30)  # Capture 20 TCP packets on ports 80 and 443
